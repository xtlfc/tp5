<!--pages/chat/chat.wxml-->
<view class="chat-container">
  <!-- èŠå¤©å¤´éƒ¨ -->
  <view class="chat-header">
    <view class="header-left">
      <button class="back-btn" bindtap="goBack">
        <text class="back-icon">â€¹</text>
      </button>
    </view>
    
    <view class="header-center" bindtap="showUserProfile">
      <image class="user-avatar" src="{{matchedUser.avatarUrl}}" mode="aspectFill"></image>
      <view class="user-info">
        <text class="user-name">{{matchedUser.nickName}}</text>
        <text class="user-status">{{userStatus}}</text>
      </view>
    </view>
    
    <view class="header-right">
      <button class="header-btn" bindtap="startVideoCall">
        <text class="header-icon">ğŸ“¹</text>
      </button>
      <button class="header-btn" bindtap="startVoiceCall">
        <text class="header-icon">ğŸ“</text>
      </button>
      <button class="header-btn" bindtap="showUserActions">
        <text class="header-icon">â‹¯</text>
      </button>
    </view>
  </view>

  <!-- èŠå¤©æ¶ˆæ¯åˆ—è¡¨ -->
  <scroll-view 
    class="chat-messages" 
    scroll-y="true" 
    scroll-into-view="{{scrollToMessage}}"
    bindscrolltoupper="loadMoreMessages"
    upper-threshold="50"
    enhanced="true"
    show-scrollbar="false"
  >
    <!-- åŠ è½½æ›´å¤š -->
    <view class="load-more" wx:if="{{isLoadingMore}}">
      <view class="loading-spinner"></view>
      <text class="loading-text">åŠ è½½ä¸­...</text>
    </view>

    <!-- æ¶ˆæ¯åˆ—è¡¨ -->
    <view class="message-list">
      <view 
        class="message-item {{item.isSelf ? 'self' : 'other'}}" 
        wx:for="{{messages}}" 
        wx:key="id"
        id="msg-{{item.id}}"
        bindlongpress="showMessageActions"
        data-message="{{item}}"
      >
        <!-- æ—¶é—´åˆ†å‰²çº¿ -->
        <view class="time-divider" wx:if="{{item.showTime}}">
          <text class="time-text">{{item.timeText}}</text>
        </view>

        <!-- æ¶ˆæ¯å†…å®¹ -->
        <view class="message-content {{item.isSelf ? 'self' : 'other'}}">
          <!-- è‡ªå·±å‘é€çš„æ¶ˆæ¯ï¼šå¤´åƒåœ¨å³ä¾§ -->
          <block wx:if="{{item.isSelf}}">
            <!-- æ¶ˆæ¯æ°”æ³¡ -->
            <view class="message-bubble self-bubble">
              <!-- æ–‡æœ¬æ¶ˆæ¯ -->
              <text class="message-text" wx:if="{{item.type === 'text'}}">{{item.content}}</text>
              
              <!-- å›¾ç‰‡æ¶ˆæ¯ -->
              <image 
                class="message-image" 
                wx:if="{{item.type === 'image'}}" 
                src="{{item.content}}" 
                mode="widthFix"
                bindtap="previewImage"
                data-url="{{item.content}}"
              ></image>

              <!-- è¯­éŸ³æ¶ˆæ¯ -->
              <voice-message 
                wx:if="{{item.type === 'voice'}}" 
                url="{{item.content.url}}" 
                duration="{{item.content.duration}}"
                isSelf="{{item.isSelf}}"
              ></voice-message>

              <!-- æ¶ˆæ¯çŠ¶æ€ -->
              <view class="message-status">
                <text class="status-text {{item.status}}">
                  {{item.status === 'sending' ? 'å‘é€ä¸­' : 
                    item.status === 'sent' ? 'å·²å‘é€' : 
                    item.status === 'read' ? 'å·²è¯»' : 'å‘é€å¤±è´¥'}}
                </text>
              </view>
            </view>
            
            <!-- å¤´åƒ -->
            <image 
              class="message-avatar self-avatar" 
              src="{{userInfo.avatarUrl}}" 
              mode="aspectFill"
              bindtap="showUserProfile"
            ></image>
          </block>

          <!-- å¯¹æ–¹å‘é€çš„æ¶ˆæ¯ï¼šå¤´åƒåœ¨å·¦ä¾§ -->
          <block wx:else>
            <!-- å¤´åƒ -->
            <image 
              class="message-avatar other-avatar" 
              src="{{matchedUser.avatarUrl}}" 
              mode="aspectFill"
              bindtap="showUserProfile"
            ></image>

            <!-- æ¶ˆæ¯æ°”æ³¡ -->
            <view class="message-bubble other-bubble">
              <!-- æ–‡æœ¬æ¶ˆæ¯ -->
              <text class="message-text" wx:if="{{item.type === 'text'}}">{{item.content}}</text>
              
              <!-- å›¾ç‰‡æ¶ˆæ¯ -->
              <image 
                class="message-image" 
                wx:if="{{item.type === 'image'}}" 
                src="{{item.content}}" 
                mode="widthFix"
                bindtap="previewImage"
                data-url="{{item.content}}"
              ></image>

              <!-- è¯­éŸ³æ¶ˆæ¯ -->
              <voice-message 
                wx:if="{{item.type === 'voice'}}" 
                url="{{item.content.url}}" 
                duration="{{item.content.duration}}"
                isSelf="{{item.isSelf}}"
              ></voice-message>
            </view>
          </block>
        </view>
      </view>
    </view>

    <!-- ç©ºçŠ¶æ€ -->
    <view class="empty-state" wx:if="{{messages.length === 0}}">
      <image class="empty-icon" src="/images/empty-chat.png" mode="aspectFit"></image>
      <text class="empty-text">å¼€å§‹èŠå¤©å§ï¼æ¶ˆæ¯çœ‹å®Œå³é”€æ¯å“¦ï½</text>
    </view>
  </scroll-view>

  <!-- è¾“å…¥åŒºåŸŸ -->
  <view class="chat-input">
    <view class="input-container">
      <!-- è¯­éŸ³æŒ‰é’® -->
      <button class="voice-btn" bindtouchstart="startRecord" bindtouchend="stopRecord" bindtouchcancel="cancelRecord">
        <text class="voice-icon">ğŸ¤</text>
      </button>
      
      <!-- è¾“å…¥æ¡† -->
      <view class="input-wrapper">
        <input 
          class="message-input" 
          placeholder="è¾“å…¥æ¶ˆæ¯..." 
          value="{{inputMessage}}"
          bindinput="onInputChange"
          bindconfirm="sendMessage"
          confirm-type="send"
          disabled="{{isSending}}"
          adjust-position="false"
        />
      </view>
      
      <!-- åŠŸèƒ½æŒ‰é’® -->
      <button class="function-btn" bindtap="showFunctionPanel">
        <text class="function-icon">+</text>
      </button>
      
      <!-- å‘é€æŒ‰é’® -->
      <button 
        class="send-btn {{inputMessage.trim() ? 'active' : ''}}" 
        bindtap="sendMessage" 
        disabled="{{!inputMessage.trim() || isSending}}"
      >
        {{isSending ? 'å‘é€ä¸­...' : 'å‘é€'}}
      </button>
    </view>
  </view>

  <!-- åŠŸèƒ½é¢æ¿ -->
  <view class="function-panel" wx:if="{{showFunctionPanel}}">
    <view class="function-grid">
      <view class="function-item" bindtap="takePhoto">
        <text class="function-item-icon">ğŸ“·</text>
        <text class="function-item-text">æ‹ç…§</text>
      </view>
      <view class="function-item" bindtap="chooseImage">
        <text class="function-item-icon">ğŸ–¼ï¸</text>
        <text class="function-item-text">ç›¸å†Œ</text>
      </view>
      <view class="function-item" bindtap="startVideoCall">
        <text class="function-item-icon">ğŸ“¹</text>
        <text class="function-item-text">è§†é¢‘</text>
      </view>
      <view class="function-item" bindtap="showEmoji">
        <text class="function-item-icon">ğŸ˜Š</text>
        <text class="function-item-text">è¡¨æƒ…</text>
      </view>
    </view>
  </view>

  <!-- å½•éŸ³æç¤º -->
  <view class="record-tip" wx:if="{{isRecording}}">
    <view class="record-content">
      <text class="record-text">{{recordTipText}}</text>
      <text class="record-time">{{recordTime}}s</text>
    </view>
  </view>

  <!-- æ¶ˆæ¯é”€æ¯æç¤º -->
  <view class="destroy-tip" wx:if="{{showDestroyTip}}">
    <text class="tip-text">ğŸ’¡ æ¶ˆæ¯å°†åœ¨å¯¹æ–¹æŸ¥çœ‹åè‡ªåŠ¨é”€æ¯</text>
  </view>
</view>