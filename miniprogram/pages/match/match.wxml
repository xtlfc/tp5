<!--pages/match/match.wxml-->
<view class="container">
  <!-- åŒ¹é…ä¸­çŠ¶æ€ -->
  <view class="matching-status" wx:if="{{isMatching}}">
    <view class="matching-card card">
      <view class="matching-content">
        <view class="matching-icon">
          <text class="icon">ğŸ²</text>
        </view>
        <text class="matching-title">æ­£åœ¨åŒ¹é…ä¸­...</text>
        <text class="matching-subtitle">å¯»æ‰¾ç›¸åŒç‚¹æ•°çš„å¼‚æ€§ç”¨æˆ·</text>
        
        <!-- å€’è®¡æ—¶ -->
        <view class="countdown-section">
          <text class="countdown-text">å‰©ä½™æ—¶é—´</text>
          <text class="countdown-time">{{countdownTime}}s</text>
        </view>
        
        <!-- è¿›åº¦æ¡ -->
        <view class="progress-bar">
          <view class="progress-fill" style="width: {{progressPercent}}%"></view>
        </view>
        
        <!-- å–æ¶ˆæŒ‰é’® -->
        <button class="cancel-btn btn-secondary" bindtap="cancelMatching">
          å–æ¶ˆåŒ¹é…
        </button>
      </view>
    </view>
  </view>

  <!-- åŒ¹é…å¤±è´¥çŠ¶æ€ -->
  <view class="match-failed" wx:if="{{matchFailed}}">
    <view class="failed-card card">
      <view class="failed-content">
        <view class="failed-icon">
          <text class="icon">ğŸ˜”</text>
        </view>
        <text class="failed-title">åŒ¹é…å¤±è´¥</text>
        <text class="failed-subtitle">30ç§’å†…æœªæ‰¾åˆ°åˆé€‚çš„åŒ¹é…å¯¹è±¡</text>
        <text class="failed-tip">å»ºè®®ç¨åå†è¯•æˆ–è°ƒæ•´åŒ¹é…æ¡ä»¶</text>
        
        <view class="failed-actions">
          <button class="retry-btn btn-primary" bindtap="retryMatch">
            é‡æ–°åŒ¹é…
          </button>
          <button class="back-btn btn-secondary" bindtap="goBack">
            è¿”å›é¦–é¡µ
          </button>
        </view>
      </view>
    </view>
  </view>

  <!-- åŒ¹é…ç»Ÿè®¡ -->
  <view class="stats-section" wx:if="{{!isMatching && !matchFailed}}">
    <view class="stats-card card">
      <view class="stats-header">
        <text class="stats-title">åŒ¹é…ç»Ÿè®¡</text>
      </view>
      <view class="stats-content">
        <view class="stat-item">
          <text class="stat-number">{{totalMatches}}</text>
          <text class="stat-label">æ€»åŒ¹é…</text>
        </view>
        <view class="stat-item">
          <text class="stat-number">{{todayMatches}}</text>
          <text class="stat-label">ä»Šæ—¥åŒ¹é…</text>
        </view>
        <view class="stat-item">
          <text class="stat-number">{{activeChats}}</text>
          <text class="stat-label">æ´»è·ƒèŠå¤©</text>
        </view>
      </view>
    </view>
  </view>

  <!-- èŠå¤©ä¼šè¯åˆ—è¡¨ -->
  <view class="chat-sessions">
    <view class="section-header">
      <text class="section-title">èŠå¤©ä¼šè¯</text>
      <text class="section-count">å…±{{chatSessions.length}}ä¸ª</text>
    </view>

    <view class="session-list" wx:if="{{chatSessions.length > 0}}">
      <view 
        class="session-item card" 
        wx:for="{{chatSessions}}" 
        wx:key="id"
        bindtap="openChat"
        data-session="{{item}}"
      >
        <view class="session-content">
          <image class="session-avatar" src="{{item.matchedUserInfo.avatarUrl}}" mode="aspectFill"></image>
          <view class="session-info">
            <view class="session-header">
              <text class="session-name">{{item.matchedUserInfo.nickName}}</text>
              <text class="session-time">{{item.lastMessageTimeText}}</text>
            </view>
            <view class="session-message">
              <text class="message-preview" wx:if="{{item.lastMessage}}">
                {{item.lastMessage.isSelf ? 'æˆ‘: ' : ''}}{{item.lastMessage.content}}
              </text>
              <text class="no-message" wx:else>æš‚æ— æ¶ˆæ¯</text>
            </view>
          </view>
          <view class="session-actions">
            <view class="unread-badge" wx:if="{{item.unreadCount > 0}}">
              <text class="badge-text">{{item.unreadCount}}</text>
            </view>
            <text class="action-icon">></text>
          </view>
        </view>
      </view>
    </view>

    <!-- ç©ºçŠ¶æ€ -->
    <view class="empty-state" wx:else>
      <image class="empty-icon" src="/images/empty-match.png" mode="aspectFit"></image>
      <text class="empty-text">è¿˜æ²¡æœ‰åŒ¹é…åˆ°æœ‹å‹å“¦ï½</text>
      <text class="empty-subtext">å¿«å»æ‘‡éª°å­å¯»æ‰¾ç¼˜åˆ†å§ï¼</text>
      <button class="go-roll-btn btn-primary" bindtap="goToRoll">
        å»æ‘‡éª°å­
      </button>
    </view>
  </view>

  <!-- åŒ¹é…å†å² -->
  <view class="match-history" wx:if="{{matchHistory.length > 0}}">
    <view class="section-header">
      <text class="section-title">åŒ¹é…å†å²</text>
      <text class="section-count">å…±{{matchHistory.length}}æ¬¡</text>
    </view>

    <view class="history-list">
      <view class="history-item card" wx:for="{{matchHistory}}" wx:key="id">
        <view class="history-content">
          <image class="history-avatar" src="{{item.matchedUser.avatarUrl}}" mode="aspectFill"></image>
          <view class="history-info">
            <text class="history-name">{{item.matchedUser.nickName}}</text>
            <text class="history-details">
              ç‚¹æ•°: {{item.diceNumber}} | è·ç¦»: {{item.distance}}km | {{item.matchTimeText}}
            </text>
          </view>
          <view class="history-status">
            <text class="status-text {{item.isActive ? 'active' : 'inactive'}}">
              {{item.isActive ? 'æ´»è·ƒ' : 'å·²ç»“æŸ'}}
            </text>
          </view>
        </view>
      </view>
    </view>
  </view>
</view>