# 微信交友小程序部署指南

## 1. 准备工作

### 1.1 注册微信小程序
1. 访问 [微信公众平台](https://mp.weixin.qq.com/)
2. 注册小程序账号
3. 获取 AppID 和 AppSecret

### 1.2 开通云开发
1. 在微信开发者工具中创建云开发环境
2. 记录环境ID
3. 开通云数据库、云存储、云函数服务

## 2. 项目配置

### 2.1 修改配置文件
1. 修改 `project.config.json` 中的 `appid` 为你的小程序 AppID
2. 修改 `miniprogram/app.js` 中的云开发环境ID

```javascript
// miniprogram/app.js
wx.cloud.init({
  env: 'your-env-id', // 替换为你的云开发环境ID
  traceUser: true,
})
```

### 2.2 创建数据库集合
在云开发控制台中创建以下数据库集合：

- `users` - 用户信息
- `rollHistory` - 摇骰子历史
- `matches` - 匹配记录
- `chatSessions` - 聊天会话
- `messages` - 聊天消息

### 2.3 设置数据库权限
为每个集合设置合适的读写权限：

```json
{
  "read": true,
  "write": true
}
```

## 3. 部署云函数

### 3.1 安装依赖
在每个云函数目录下安装依赖：

```bash
cd cloudfunctions/login
npm install

cd ../match
npm install

cd ../chat
npm install
```

### 3.2 上传云函数
在微信开发者工具中：
1. 右键点击云函数目录
2. 选择"上传并部署：云端安装依赖"
3. 等待部署完成

## 4. 配置小程序

### 4.1 配置服务器域名
在微信公众平台配置以下域名：
- request合法域名：添加你的云开发域名
- socket合法域名：添加你的云开发域名
- uploadFile合法域名：添加你的云开发域名
- downloadFile合法域名：添加你的云开发域名

### 4.2 配置权限
在 `app.json` 中已配置了必要的权限：
- 位置权限
- 用户信息权限

## 5. 测试和发布

### 5.1 本地测试
1. 在微信开发者工具中预览
2. 测试各项功能是否正常
3. 检查云函数是否正常工作

### 5.2 提交审核
1. 在微信开发者工具中点击"上传"
2. 填写版本号和项目备注
3. 提交审核

### 5.3 发布上线
审核通过后，在微信公众平台发布小程序

## 6. 数据库索引优化

为了提高查询性能，建议为以下字段创建索引：

### 6.1 users 集合
- `openid` (唯一索引)
- `createTime` (降序)

### 6.2 rollHistory 集合
- `openid` + `createTime` (复合索引)
- `diceNumber` + `createTime` (复合索引)

### 6.3 matches 集合
- `user1Id` + `matchTime` (复合索引)
- `user2Id` + `matchTime` (复合索引)

### 6.4 messages 集合
- `chatId` + `createTime` (复合索引)
- `senderId` + `createTime` (复合索引)

## 7. 监控和维护

### 7.1 云开发监控
- 监控云函数调用次数和错误率
- 监控数据库读写性能
- 监控存储使用情况

### 7.2 日志分析
- 查看云函数日志
- 分析用户行为数据
- 优化匹配算法

## 8. 常见问题

### 8.1 云函数调用失败
- 检查云函数是否正确部署
- 检查环境ID是否正确
- 查看云函数日志

### 8.2 数据库查询慢
- 检查是否创建了合适的索引
- 优化查询语句
- 考虑分页查询

### 8.3 位置权限问题
- 检查小程序是否申请了位置权限
- 检查用户是否授权了位置权限
- 提供手动输入位置的备选方案

## 9. 安全注意事项

### 9.1 数据安全
- 定期备份数据库
- 设置合适的数据库权限
- 对敏感数据进行加密

### 9.2 用户隐私
- 遵守微信小程序隐私政策
- 合理使用用户数据
- 提供数据删除功能

### 9.3 内容审核
- 对用户上传的图片进行审核
- 对聊天内容进行监控
- 建立举报机制

## 10. 更新维护

### 10.1 版本更新
- 定期更新小程序版本
- 修复已知问题
- 添加新功能

### 10.2 性能优化
- 优化代码结构
- 减少网络请求
- 优化页面加载速度

### 10.3 用户体验
- 收集用户反馈
- 优化界面设计
- 提升操作流畅度